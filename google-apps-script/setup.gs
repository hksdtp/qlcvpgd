/**
 * üöÄ Task Management Google Sheets Auto Setup Script
 * T·ª± ƒë·ªông t·∫°o v√† c·∫•u h√¨nh Google Sheets cho ·ª©ng d·ª•ng Task Management
 * 
 * C√°ch s·ª≠ d·ª•ng:
 * 1. M·ªü script.google.com
 * 2. T·∫°o project m·ªõi
 * 3. Paste code n√†y v√†o
 * 4. Ch·∫°y function createTaskManagementSheet()
 * 5. Authorize permissions
 * 6. Ki·ªÉm tra logs ƒë·ªÉ l·∫•y Spreadsheet ID
 */

// ===== CONFIGURATION =====
const CONFIG = {
  SPREADSHEET_NAME: `Task Management Database - ${new Date().toLocaleDateString('vi-VN')}`,
  SHEET_NAME: 'Tasks',
  SAMPLE_DATA_COUNT: 10,
  DEPARTMENTS: ['Design', 'Development', 'Marketing', 'Documentation', 'Testing', 'Management'],
  STATUSES: ['todo', 'in-progress', 'completed'],
  COLORS: {
    HEADER: '#4F46E5',
    TODO: '#EF4444',
    IN_PROGRESS: '#F59E0B', 
    COMPLETED: '#10B981'
  }
};

// ===== MAIN SETUP FUNCTION =====
/**
 * üéØ Main function - Ch·∫°y function n√†y ƒë·ªÉ t·∫°o to√†n b·ªô setup
 */
function createTaskManagementSheet() {
  try {
    console.log('üöÄ B·∫Øt ƒë·∫ßu t·∫°o Task Management Google Sheet...');
    
    // 1. T·∫°o spreadsheet m·ªõi
    const spreadsheet = SpreadsheetApp.create(CONFIG.SPREADSHEET_NAME);
    const spreadsheetId = spreadsheet.getId();
    const url = spreadsheet.getUrl();
    
    console.log(`‚úÖ ƒê√£ t·∫°o spreadsheet: ${CONFIG.SPREADSHEET_NAME}`);
    console.log(`üìä Spreadsheet ID: ${spreadsheetId}`);
    console.log(`üîó URL: ${url}`);
    
    // 2. Setup Tasks sheet
    setupTasksSheet(spreadsheet);
    
    // 3. Th√™m sample data
    addSampleData(spreadsheet);
    
    // 4. Format sheet
    formatSheet(spreadsheet);
    
    // 5. Setup data validation
    setupDataValidation(spreadsheet);
    
    // 6. Setup sharing permissions
    shareSheet(spreadsheet);
    
    // 7. Generate integration config
    generateIntegrationConfig(spreadsheetId, url);
    
    console.log('üéâ HO√ÄN TH√ÄNH! Google Sheets ƒë√£ s·∫µn s√†ng s·ª≠ d·ª•ng.');
    console.log('üìã Ki·ªÉm tra logs ƒë·ªÉ l·∫•y th√¥ng tin integration.');
    
    return {
      spreadsheetId: spreadsheetId,
      url: url,
      success: true
    };
    
  } catch (error) {
    console.error('‚ùå L·ªói khi t·∫°o sheet:', error);
    return {
      success: false,
      error: error.toString()
    };
  }
}

// ===== SETUP FUNCTIONS =====

/**
 * üìã Setup c·∫•u tr√∫c sheet Tasks
 */
function setupTasksSheet(spreadsheet) {
  console.log('üìã ƒêang setup Tasks sheet...');
  
  // X√≥a sheet m·∫∑c ƒë·ªãnh v√† t·∫°o sheet Tasks
  const defaultSheet = spreadsheet.getSheets()[0];
  defaultSheet.setName(CONFIG.SHEET_NAME);
  
  const sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);
  
  // T·∫°o headers
  const headers = [
    'id',
    'title', 
    'description',
    'status',
    'department',
    'subtasks',
    'createdAt',
    'updatedAt'
  ];
  
  // Set headers
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setValues([headers]);
  
  // Resize columns
  sheet.setColumnWidth(1, 120); // id
  sheet.setColumnWidth(2, 200); // title
  sheet.setColumnWidth(3, 300); // description
  sheet.setColumnWidth(4, 100); // status
  sheet.setColumnWidth(5, 120); // department
  sheet.setColumnWidth(6, 400); // subtasks
  sheet.setColumnWidth(7, 150); // createdAt
  sheet.setColumnWidth(8, 150); // updatedAt
  
  console.log('‚úÖ Tasks sheet ƒë√£ ƒë∆∞·ª£c setup');
}

/**
 * üìä Th√™m sample data
 */
function addSampleData(spreadsheet) {
  console.log('üìä ƒêang th√™m sample data...');
  
  const sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);
  const sampleTasks = generateSampleTasks();
  
  // Convert tasks to rows
  const rows = sampleTasks.map(task => [
    task.id,
    task.title,
    task.description || '',
    task.status,
    task.department || '',
    JSON.stringify(task.subtasks || []),
    task.createdAt,
    new Date().toISOString() // updatedAt
  ]);
  
  // Add data starting from row 2
  if (rows.length > 0) {
    const dataRange = sheet.getRange(2, 1, rows.length, 8);
    dataRange.setValues(rows);
  }
  
  console.log(`‚úÖ ƒê√£ th√™m ${rows.length} sample tasks`);
}

/**
 * üé® Format sheet
 */
function formatSheet(spreadsheet) {
  console.log('üé® ƒêang format sheet...');
  
  const sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);
  
  // Format header row
  const headerRange = sheet.getRange(1, 1, 1, 8);
  headerRange.setBackground(CONFIG.COLORS.HEADER);
  headerRange.setFontColor('white');
  headerRange.setFontWeight('bold');
  headerRange.setHorizontalAlignment('center');
  
  // Freeze header row
  sheet.setFrozenRows(1);
  
  // Format data rows
  const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, 8);
  dataRange.setVerticalAlignment('top');
  dataRange.setWrap(true);
  
  // Conditional formatting for status column
  const statusRange = sheet.getRange(2, 4, sheet.getLastRow() - 1, 1);
  
  // Todo - Red
  const todoRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo('todo')
    .setBackground('#FEE2E2')
    .setFontColor('#DC2626')
    .setRanges([statusRange])
    .build();
    
  // In Progress - Yellow  
  const progressRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo('in-progress')
    .setBackground('#FEF3C7')
    .setFontColor('#D97706')
    .setRanges([statusRange])
    .build();
    
  // Completed - Green
  const completedRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo('completed')
    .setBackground('#D1FAE5')
    .setFontColor('#059669')
    .setRanges([statusRange])
    .build();
  
  sheet.setConditionalFormatRules([todoRule, progressRule, completedRule]);
  
  console.log('‚úÖ Sheet formatting ho√†n th√†nh');
}

/**
 * ‚úÖ Setup data validation
 */
function setupDataValidation(spreadsheet) {
  console.log('‚úÖ ƒêang setup data validation...');
  
  const sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);
  
  // Status validation
  const statusValidation = SpreadsheetApp.newDataValidation()
    .requireValueInList(CONFIG.STATUSES)
    .setAllowInvalid(false)
    .setHelpText('Ch·ªçn: todo, in-progress, ho·∫∑c completed')
    .build();
    
  const statusRange = sheet.getRange(2, 4, 1000, 1); // Column D (status)
  statusRange.setDataValidation(statusValidation);
  
  // Department validation
  const deptValidation = SpreadsheetApp.newDataValidation()
    .requireValueInList(CONFIG.DEPARTMENTS)
    .setAllowInvalid(true)
    .setHelpText('Ch·ªçn department ho·∫∑c ƒë·ªÉ tr·ªëng')
    .build();
    
  const deptRange = sheet.getRange(2, 5, 1000, 1); // Column E (department)
  deptRange.setDataValidation(deptValidation);
  
  console.log('‚úÖ Data validation ƒë√£ ƒë∆∞·ª£c setup');
}

/**
 * üîó Setup sharing permissions
 */
function shareSheet(spreadsheet) {
  console.log('üîó ƒêang setup sharing permissions...');

  try {
    // Set to anyone with link can view
    const file = DriveApp.getFileById(spreadsheet.getId());
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    console.log('‚úÖ Sheet ƒë√£ ƒë∆∞·ª£c share v·ªõi "Anyone with link can view"');
  } catch (error) {
    console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ t·ª± ƒë·ªông setup sharing. Vui l√≤ng share manually.');
  }
}

/**
 * üìù Generate integration config
 */
function generateIntegrationConfig(spreadsheetId, url) {
  console.log('üìù Generating integration config...');

  console.log('\n=== üîß INTEGRATION CONFIG ===');
  console.log(`Spreadsheet ID: ${spreadsheetId}`);
  console.log(`URL: ${url}`);
  console.log('\n=== üìã .env.local CONFIG ===');
  console.log(`VITE_GOOGLE_SPREADSHEET_ID=${spreadsheetId}`);
  console.log('VITE_GOOGLE_SHEETS_API_KEY=your_api_key_here');
  console.log('\n=== üìä SHEET STRUCTURE ===');
  console.log('Sheet Name: Tasks');
  console.log('Columns: id | title | description | status | department | subtasks | createdAt | updatedAt');
  console.log('\n=== üéØ NEXT STEPS ===');
  console.log('1. Copy Spreadsheet ID v√†o .env.local');
  console.log('2. T·∫°o Google Cloud API Key');
  console.log('3. Restart ·ª©ng d·ª•ng: npm run dev');
  console.log('4. Test integration t·∫°i http://localhost:3001');
}

/**
 * üé≤ Generate sample tasks
 */
function generateSampleTasks() {
  const tasks = [
    {
      id: 'task_1',
      title: 'Thi·∫øt k·∫ø giao di·ªán ng∆∞·ªùi d√πng ch√≠nh',
      description: 'T·∫°o mockup v√† wireframe cho trang ch·ªß ·ª©ng d·ª•ng',
      status: 'in-progress',
      department: 'Design',
      subtasks: [
        { id: 'sub_1_1', title: 'Research UI trends', completed: true },
        { id: 'sub_1_2', title: 'Create wireframes', completed: true },
        { id: 'sub_1_3', title: 'Design mockups', completed: false }
      ],
      createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
    },
    {
      id: 'task_2',
      title: 'Ph√°t tri·ªÉn API backend',
      description: 'X√¢y d·ª±ng REST API cho qu·∫£n l√Ω tasks v√† users',
      status: 'todo',
      department: 'Development',
      subtasks: [
        { id: 'sub_2_1', title: 'Setup database schema', completed: false },
        { id: 'sub_2_2', title: 'Create API endpoints', completed: false },
        { id: 'sub_2_3', title: 'Write unit tests', completed: false }
      ],
      createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString()
    },
    {
      id: 'task_3',
      title: 'Vi·∫øt t√†i li·ªáu h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng',
      description: 'T·∫°o user manual v√† developer documentation',
      status: 'completed',
      department: 'Documentation',
      subtasks: [
        { id: 'sub_3_1', title: 'User guide', completed: true },
        { id: 'sub_3_2', title: 'API documentation', completed: true }
      ],
      createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString()
    },
    {
      id: 'task_4',
      title: 'T·ªëi ∆∞u h√≥a hi·ªáu su·∫•t ·ª©ng d·ª•ng',
      description: 'C·∫£i thi·ªán t·ªëc ƒë·ªô load v√† responsive design',
      status: 'in-progress',
      department: 'Development',
      subtasks: [
        { id: 'sub_4_1', title: 'Code splitting', completed: true },
        { id: 'sub_4_2', title: 'Image optimization', completed: false },
        { id: 'sub_4_3', title: 'Bundle analysis', completed: false }
      ],
      createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()
    },
    {
      id: 'task_5',
      title: 'Chi·∫øn l∆∞·ª£c marketing s·∫£n ph·∫©m',
      description: 'L·∫≠p k·∫ø ho·∫°ch qu·∫£ng b√° v√† thu h√∫t ng∆∞·ªùi d√πng',
      status: 'todo',
      department: 'Marketing',
      subtasks: [
        { id: 'sub_5_1', title: 'Market research', completed: false },
        { id: 'sub_5_2', title: 'Content strategy', completed: false },
        { id: 'sub_5_3', title: 'Social media plan', completed: false }
      ],
      createdAt: new Date().toISOString()
    },
    {
      id: 'task_6',
      title: 'Testing v√† QA to√†n di·ªán',
      description: 'Ki·ªÉm tra l·ªói v√† ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng s·∫£n ph·∫©m',
      status: 'todo',
      department: 'Testing',
      subtasks: [
        { id: 'sub_6_1', title: 'Unit testing', completed: false },
        { id: 'sub_6_2', title: 'Integration testing', completed: false },
        { id: 'sub_6_3', title: 'User acceptance testing', completed: false }
      ],
      createdAt: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString()
    }
  ];

  return tasks;
}

/**
 * üßπ Helper function - X√≥a t·∫•t c·∫£ data (ƒë·ªÉ test l·∫°i)
 */
function clearAllData() {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = spreadsheet.getSheetByName(CONFIG.SHEET_NAME);

  if (sheet) {
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      sheet.getRange(2, 1, lastRow - 1, 8).clearContent();
      console.log('üßπ ƒê√£ x√≥a t·∫•t c·∫£ data');
    }
  }
}

/**
 * üîÑ Helper function - Refresh sample data
 */
function refreshSampleData() {
  clearAllData();
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  addSampleData(spreadsheet);
  console.log('üîÑ ƒê√£ refresh sample data');
}
